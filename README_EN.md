# üöÄ N8N Multi-Mode Enhanced Installation Script v4.0

![N8N](https://img.shields.io/badge/N8N-Automation-blue) ![Docker](https://img.shields.io/badge/Docker-Containerized-blue) ![SSL](https://img.shields.io/badge/SSL-Auto-green) ![Multi-Domain](https://img.shields.io/badge/Multi--Domain-Support-orange) ![PostgreSQL](https://img.shields.io/badge/PostgreSQL-Database-blue) ![API](https://img.shields.io/badge/News%20API-FastAPI-red) ![Telegram](https://img.shields.io/badge/Telegram-Bot-blue) ![Google Drive](https://img.shields.io/badge/Google%20Drive-Backup-green) ![Cloudflare](https://img.shields.io/badge/Cloudflare-Tunnel-purple) ![Auto-Fix](https://img.shields.io/badge/Auto--Fix-Enabled-green)

**üé¨ PLEASE SUBSCRIBE TO MY YOUTUBE CHANNEL TO SUPPORT ME! üîî**
üëâ [SUBSCRIBE HERE](https://www.youtube.com/@kalvinthiensocial?sub_confirmation=1) to receive the latest videos about N8N, Automation and many other interesting technologies!

Automated N8N installation script with comprehensive features and remote management, including:

## ‚ú® New Features Version 4.0

### üåê Multi-Mode Installation Support
- **Localhost Mode** - No domain required, access via IP
- **Domain Mode** - Requires domain and DNS with automatic SSL
- **Cloudflare Tunnel Mode** - No public IP needed, completely secure
- **Smart Mode Detection** - Automatically selects the most suitable mode

### üîß Auto-Fix Integration System
- **No more 503 errors!** - Automatically fixes all common issues
- **Permission Auto-Fix** - Automatically fixes directory permissions (1000:1000)
- **Docker Network Recovery** - Automatically recreates broken networks
- **Service Health Recovery** - Automatically restarts unstable services
- **PostgreSQL Connection Fix** - Automatically fixes database connection issues
- **SSL Certificate Recovery** - Automatically fixes SSL problems

### ‚òÅÔ∏è Cloudflare Tunnel Support
- **No Public IP Required** - Works even without public IP
- **Automatic SSL** - SSL certificates automatically from Cloudflare
- **DDoS Protection** - Protection against DDoS attacks
- **Zero Trust Security** - High-level security
- **Easy Setup** - Only needs tunnel token from Cloudflare dashboard

### üîå Custom Port Configuration
- **Dynamic Port Assignment** - Automatically finds available ports
- **Multi-Instance Ports** - Each N8N instance has its own port
- **Port Conflict Resolution** - Automatically avoids port conflicts
- **Custom Base Ports** - Can change default base ports

### üìä Enhanced Health Monitoring & Auto-Recovery
- **Real-time Health Checks** - Continuously monitors system health
- **Auto-Recovery System** - Automatically recovers when errors occur
- **Performance Metrics** - Real-time performance monitoring
- **Telegram Alerts** - Error notifications via Telegram
- **Retry Mechanism** - Automatically retries when failed

### üîí Enhanced Dashboard Security
- **Basic Authentication** - Protects dashboard with username/password
- **Secure Credentials** - Securely stores login information
- **IP Filtering** - Only allows authorized IPs
- **Session Management** - Manages login sessions

### ü§ñ Telegram Bot Management (Enhanced)
- **Complete remote management** via Telegram
- **Real-time monitoring** and alerts
- **Quick actions**: restart, backup, logs, health check
- **Real-time performance metrics**
- **Security**: Only authorized Chat ID
- **Auto-Fix Commands** - Fix commands from Telegram

### ‚òÅÔ∏è Google Drive Auto Backup (Enhanced)
- **Automatic upload** backup to Google Drive
- **Folder structure** by year/month/domain
- **Easy restore** from Google Drive
- **OAuth2 authentication** secure
- **Cross-platform** access
- **Auto-Fix Integration** - Automatically fixes backup issues

### üìä Web Dashboard (Enhanced)
- **Browser-based** management interface
- **Real-time charts** and metrics
- **Mobile responsive** design
- **Quick actions** and troubleshooting
- **Multi-user** support ready
- **Auto-Fix Dashboard** - Auto-fix management interface

### üîí Enhanced Security (Version 4.0)
- **Basic Authentication** for N8N instances
- **IP filtering** and whitelist
- **Fail2ban** protection
- **SSL security headers**
- **Advanced rate limiting**
- **Cloudflare Zero Trust** integration

### üåê Multi-Domain Support (Enhanced)
- **Multiple N8N instances** on the same server
- **Efficient resource sharing** (News API, PostgreSQL)
- **Centralized management** of backup and monitoring
- **Automatic SSL** for all domains
- **Auto-Fix Multi-Domain** - Automatically fixes all instances

### üêò PostgreSQL Database Support (Enhanced)
- **High performance** better than SQLite
- **Better concurrent connections**
- **Easy backup and restore**
- **Database sharing** between instances
- **Completely free**
- **Auto-Fix Database** - Automatically fixes connection issues

## üë®‚Äçüíª Author Information

**üåü Nguy·ªÖn Ng·ªçc Thi·ªán üåü**
- üì∫ **YouTube**: [Kalvin Thien Social](https://www.youtube.com/@kalvinthiensocial?sub_confirmation=1) - **üî• PLEASE SUBSCRIBE TO SUPPORT! üî•**
- üìò **Facebook**: [@Ban.Thien.Handsome](https://www.facebook.com/Ban.Thien.Handsome/)
- üì± **Zalo/Phone**: 08.8888.4749
- üé¨ **N8N Playlist**: [N8N Video List](https://www.youtube.com/@kalvinthiensocial/playlists)
- üöÄ **Update Date**: 01/07/2025  
- üÜï **Version**: 4.0 Enhanced - Multi-Mode + Auto-Fix + Cloudflare Tunnel + Health Monitoring + Custom Ports

> üí° **Don't forget to SUBSCRIBE and üîî to not miss the latest useful videos!**
> 
> üéØ My channel shares knowledge about:
> - ü§ñ N8N Automation workflows
> - üê≥ Docker & DevOps
> - üíª Server management  
> - üöÄ Latest tech tutorials
> - üì± Social media automation

## üñ•Ô∏è Supported Environments

‚úÖ **Ubuntu VPS/Server** (Recommended)  
‚úÖ **Ubuntu on Windows WSL**  
‚úÖ **Ubuntu Docker Environment**  
‚úÖ **Automatic detection** and environment handling  
‚úÖ **Cloudflare Tunnel** - No public IP needed

## üìã System Requirements

### Basic
- **OS**: Ubuntu 20.04+ (VPS or WSL)
- **RAM**: Minimum 2GB (recommended 4GB+ for multi-domain)
- **Disk**: 20GB+ free space
- **Network**: Domains pointed to server (for Domain Mode)
- **Permission**: Root access

### Enhanced Features (Version 4.0)
- **RAM**: Recommended 4GB+ (each N8N instance ~512MB)
- **CPU**: 2+ cores for good performance
- **Disk**: 30GB+ for multiple instances + backups
- **Google Account**: For Google Drive backup (optional)
- **Telegram Bot**: For remote management (optional)
- **Cloudflare Account**: For Cloudflare Tunnel (optional)

## üöÄ Quick Installation

### 1Ô∏è‚É£ Localhost Mode Installation (No domain required)

```bash
cd /tmp && curl -sSL https://raw.githubusercontent.com/KalvinThien/install-n8n-ffmpeg/main/auto_cai_dat_n8n.sh | tr -d '\r' > install_n8n.sh && chmod +x install_n8n.sh && sudo bash install_n8n.sh -l
```

### 2Ô∏è‚É£ Cloudflare Tunnel Mode Installation (No public IP needed)

```bash
cd /tmp && curl -sSL https://raw.githubusercontent.com/KalvinThien/install-n8n-ffmpeg/main/auto_cai_dat_n8n.sh | tr -d '\r' > install_n8n.sh && chmod +x install_n8n.sh && sudo bash install_n8n.sh -f
```

### 3Ô∏è‚É£ Multi-Domain + PostgreSQL Installation

```bash
cd /tmp && curl -sSL https://raw.githubusercontent.com/KalvinThien/install-n8n-ffmpeg/main/auto_cai_dat_n8n.sh | tr -d '\r' > install_n8n.sh && chmod +x install_n8n.sh && sudo bash install_n8n.sh -m -p
```

### 4Ô∏è‚É£ Full Features Installation with Auto-Fix

```bash
cd /tmp && curl -sSL https://raw.githubusercontent.com/KalvinThien/install-n8n-ffmpeg/main/auto_cai_dat_n8n.sh | tr -d '\r' > install_n8n.sh && chmod +x install_n8n.sh && sudo bash install_n8n.sh -m -p -g -t
```

### 5Ô∏è‚É£ Advanced Options Version 4.0

```bash
# Localhost mode with auto-fix
sudo ./auto_cai_dat_n8n.sh -l

# Cloudflare Tunnel mode
sudo ./auto_cai_dat_n8n.sh -f

# Multi-domain with PostgreSQL and auto-fix
sudo ./auto_cai_dat_n8n.sh -m -p

# Full features with all capabilities
sudo ./auto_cai_dat_n8n.sh -m -p -g -t

# Clean install with full features
sudo ./auto_cai_dat_n8n.sh -c -m -p -g -t

# Disable auto-fix (not recommended)
sudo ./auto_cai_dat_n8n.sh --no-auto-fix

# Show help
./auto_cai_dat_n8n.sh -h
```

## üîß Installation Process Version 4.0

The script will guide you through the steps:

### Installation Modes (New)
1. **Localhost Mode** - No domain required, access via IP
2. **Domain Mode** - Requires domain and DNS with automatic SSL
3. **Cloudflare Tunnel Mode** - No public IP needed, completely secure

### Setup Process (Enhanced)
1. **Choose Installation Mode** - Localhost/Domain/Cloudflare
2. **Setup Swap** automatically (enhanced for multi-domain)
3. **Enter domains** (single or multiple)
4. **Custom Port Configuration** - Automatically allocate ports
5. **Dashboard Security** - Basic Auth setup
6. **Configure PostgreSQL** (if selected)
7. **Configure News API** (optional)
8. **Configure Telegram** (optional)
9. **Configure Google Drive** (if selected)
10. **Configure Cloudflare Tunnel** (if selected)
11. **Verify DNS** for all domains (Domain Mode)
12. **Install Docker** & dependencies
13. **Build & start** all containers with auto-fix
14. **Setup SSL** for all domains
15. **Setup services** (Dashboard, Telegram Bot, Health Monitor)
16. **Auto-Fix Integration** - Check and fix errors automatically

## üîß Auto-Fix System (Version 4.0)

### üõ†Ô∏è Automatically Fix Common Issues
- **Permission Issues** - Automatically fixes directory permissions (1000:1000)
- **Docker Network Problems** - Automatically recreates broken networks
- **Container Health Issues** - Automatically restarts unstable containers
- **PostgreSQL Connection** - Automatically fixes database connection
- **SSL Certificate Problems** - Automatically fixes SSL issues
- **Port Conflicts** - Automatically finds available ports

### üîÑ Auto-Recovery Features
- **Health Monitoring** - Continuously monitors system health
- **Retry Mechanism** - Automatically retries when failed
- **Graceful Degradation** - System continues working when errors occur
- **Telegram Alerts** - Error notifications and fix status

### üìä Auto-Fix Commands
```bash
# Automatically fix all errors
/home/n8n/auto-fix.sh

# Fix permissions
/home/n8n/auto-fix.sh permissions

# Fix Docker networks
/home/n8n/auto-fix.sh networks

# Fix PostgreSQL
/home/n8n/auto-fix.sh database

# Fix SSL certificates
/home/n8n/auto-fix.sh ssl
```

## ‚òÅÔ∏è Cloudflare Tunnel Mode (Version 4.0)

### üåê Cloudflare Tunnel Features
- **No Public IP Required** - Works even without public IP
- **Automatic SSL** - SSL certificates automatically from Cloudflare
- **DDoS Protection** - Protection against DDoS attacks
- **Zero Trust Security** - High-level security
- **Easy Setup** - Only needs tunnel token from Cloudflare dashboard

### üîß Cloudflare Tunnel Setup
1. Visit [Cloudflare Zero Trust](https://one.dash.cloudflare.com/)
2. Go to Zero Trust ‚Üí Access ‚Üí Tunnels
3. Create a tunnel ‚Üí Cloudflared
4. Name the tunnel (e.g., n8n-tunnel)
5. Copy tunnel token
6. Enter token in script

### üìÅ Cloudflare Structure
```
/home/n8n/cloudflare/
‚îú‚îÄ‚îÄ config.yml              # Tunnel configuration
‚îú‚îÄ‚îÄ credentials.json        # Cloudflare credentials
‚îî‚îÄ‚îÄ tunnel.log             # Tunnel logs
```

## üîå Custom Port Configuration (Version 4.0)

### üåê Dynamic Port Assignment
- **Auto Port Detection** - Automatically finds available ports
- **Port Conflict Resolution** - Avoids port conflicts
- **Custom Base Ports** - Can change default base ports
- **Multi-Instance Ports** - Each N8N instance has its own port

### üìä Port Management
```bash
# Default ports
N8N Base Port: 5678
API Base Port: 8000
Dashboard Port: 8080

# Multi-domain ports
Instance 1: 5678
Instance 2: 5800
Instance 3: 5801
...
```

## üìä Enhanced Health Monitoring (Version 4.0)

### üè• Health Check System
- **Real-time Monitoring** - Continuously monitors system health
- **Auto-Recovery** - Automatically recovers when errors occur
- **Performance Metrics** - Real-time performance monitoring
- **Telegram Alerts** - Error notifications via Telegram

### üîÑ Health Check Features
```bash
# Health check endpoints
N8N: /healthz
News API: /health
PostgreSQL: pg_isready
Caddy: Built-in health checks

# Health check interval: 30s
# Retry attempts: 3
# Auto-recovery: Enabled
```

## ü§ñ Telegram Bot Management (Enhanced Version 4.0)

### üîß Basic Bot Commands
```
/start          - Start bot
/status         - Status of all instances
/health         - Detailed health check
/performance    - Performance metrics
/help           - Command list
```

### üõ†Ô∏è Service Management (Enhanced)
```
/restart all              - Restart all services
/restart n8n              - Restart N8N container
/restart caddy            - Restart Caddy proxy
/restart postgres         - Restart PostgreSQL
/auto-fix                 - Run auto-fix system
/auto-fix permissions     - Fix permissions
/auto-fix networks        - Fix Docker networks
/auto-fix database        - Fix PostgreSQL
/auto-fix ssl             - Fix SSL certificates
```

### üìã Logs & Monitoring (Enhanced)
```
/logs all                 - Logs of all services
/logs n8n 50              - Last 50 lines of N8N logs
/backup                   - Run manual backup
/troubleshoot             - Run diagnostic
/health-monitor           - Health monitor status
```

### üìä Example Output (Enhanced)
```
üöÄ N8N System Status v4.0

üìä System Info:
‚Ä¢ Uptime: up 2 days, 14 hours, 32 minutes
‚Ä¢ Memory: 2.1G/4.0G
‚Ä¢ Disk Usage: 45%
‚Ä¢ Auto-Fix: ‚úÖ Enabled
‚Ä¢ Health Monitor: ‚úÖ Active

üåê Installation Mode: Cloudflare Tunnel
üåê Domains (3):
‚Ä¢ Instance 1: n8n1.example.com (Port: 5678)
‚Ä¢ Instance 2: n8n2.example.com (Port: 5800)
‚Ä¢ Instance 3: n8n3.example.com (Port: 5801)

üê≥ Containers (6):
‚úÖ n8n-container-1: running (healthy)
‚úÖ n8n-container-2: running (healthy)
‚úÖ caddy-proxy: running (healthy)
‚úÖ postgres-n8n: running (healthy)
‚úÖ cloudflared: running (healthy)
‚úÖ news-api-container: running (healthy)

üîß Auto-Fix Status:
‚Ä¢ Last Check: 2 minutes ago
‚Ä¢ Issues Fixed: 0
‚Ä¢ System Health: ‚úÖ Excellent
```

## ‚òÅÔ∏è Google Drive Backup System (Enhanced Version 4.0)

### üîß Google Drive API Setup
1. Visit [Google Cloud Console](https://console.developers.google.com/)
2. Create new project or select existing project
3. Enable Google Drive API
4. Create Service Account credentials
5. Download JSON credentials file
6. Share Google Drive folder with service account

### üìÅ Backup Structure (Enhanced)
```
N8N-Backups/
‚îú‚îÄ‚îÄ 2025/
‚îÇ   ‚îú‚îÄ‚îÄ 06-June/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain1.com/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ n8n_backup_20250628_140000.zip
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ n8n_backup_20250627_020000.zip
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain2.com/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ All-Domains/
‚îÇ   ‚îî‚îÄ‚îÄ 07-July/
‚îî‚îÄ‚îÄ 2024/
```

### üîÑ Auto Backup Features (Enhanced)
- **Daily upload** to Google Drive
- **Organized by** year/month/domain
- **Automatic cleanup** of old backups
- **Telegram notifications** with status
- **Fallback local** if upload fails
- **Auto-Fix Integration** - Automatically fixes backup issues

## üìä Web Dashboard (Enhanced Version 4.0)

### üåê Dashboard Access
```
http://YOUR_SERVER_IP:8080
```

### üìà Dashboard Features (Enhanced)
- **Real-time monitoring** of all instances
- **System metrics** (CPU, Memory, Disk, Network)
- **Container status** with health checks
- **SSL certificate** monitoring
- **Backup status** and history
- **Quick actions** (restart, backup, logs)
- **Mobile responsive** design
- **Auto-refresh** every 30 seconds
- **Auto-Fix Dashboard** - Auto-fix management interface
- **Health Monitor Status** - Health monitoring status

### üîß Quick Actions (Enhanced)
- üîÑ **Refresh Data** - Update realtime
- üîÑ **Restart All** - Restart all services
- üíæ **Manual Backup** - Run manual backup
- üìã **View Logs** - View logs in new tab
- ‚¨ÜÔ∏è **Update System** - Update system
- üîß **Troubleshoot** - Run diagnostic script
- üõ†Ô∏è **Auto-Fix** - Run auto-fix system
- üè• **Health Check** - Run manual health check

## üì∞ News Content API (Enhanced Version 4.0)

### üîë Authentication
All API calls require Bearer Token:
```bash
Authorization: Bearer YOUR_TOKEN_HERE
```

### üìñ API Documentation
After installation, visit:
- **Homepage**: `https://api.yourdomain.com/`
- **Swagger UI**: `https://api.yourdomain.com/docs`
- **ReDoc**: `https://api.yourdomain.com/redoc`

### üíª cURL Example
```bash
# Extract article content
curl -X POST "https://api.yourdomain.com/extract-article" \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{
       "url": "https://dantri.com.vn/the-gioi.htm",
       "language": "vi",
       "extract_images": true,
       "summarize": true
     }'
```

## üíæ Enhanced Backup & Restore System (Version 4.0)

### üîÑ Multi-Domain Backup Features (Enhanced)
- **ZIP compression** optimized for size
- **Multi-domain backup** all instances simultaneously
- **PostgreSQL databases** backup separately for each instance
- **SSL certificates** backup and restore
- **Configuration files** backup
- **Metadata** detailed for each backup
- **Auto-Fix Integration** - Automatically fixes backup issues

### üì± Telegram Integration (Enhanced)
- **Detailed reports** about all instances
- **File upload** if <50MB
- **Status notifications** success/failure
- **Fallback**: Keep backup local if Telegram fails
- **Auto-Fix Notifications** - Auto-fix status notifications

### ‚òÅÔ∏è Google Drive Integration (Enhanced)
- **Auto-upload** after each backup
- **Organized folders** by domain and date
- **Easy restore** from Google Drive
- **Cross-platform** access
- **Auto-Fix Integration** - Automatically fixes upload issues

### üîÑ Restore System (Enhanced)
```bash
# Restore from backup file
/home/n8n/restore-from-backup.sh /path/to/backup.zip

# Restore specific domain
/home/n8n/restore-from-backup.sh /path/to/backup.zip domain.com

# Restore will:
# 1. Stop all services
# 2. Restore configuration files
# 3. Restore SSL certificates
# 4. Restore PostgreSQL databases
# 5. Restore N8N instances data
# 6. Import workflows and credentials
# 7. Start all services
# 8. Run auto-fix to ensure stability
```

## üîí Enhanced Security Features (Version 4.0)

### üîê Basic Authentication (Enhanced)
- **Auto-generated** username/password for N8N
- **Secure storage** of credentials
- **Easy rotation** of passwords
- **Dashboard Security** - Basic Auth for dashboard

### üõ°Ô∏è IP Filtering (Enhanced)
- **Whitelist** allowed IP addresses
- **CIDR block** support
- **Easy configuration** via file
- **Cloudflare Integration** - IP filtering with Cloudflare

### üö´ Fail2ban Protection (Enhanced)
- **Auto-ban** malicious IPs
- **Custom rules** for N8N
- **Configurable** ban times
- **Cloudflare Integration** - Fail2ban with Cloudflare

### üîí SSL Security Headers (Enhanced)
- **HSTS** enforcement
- **XSS protection**
- **Content Security Policy**
- **Frame protection**
- **Cloudflare Zero Trust** integration

## üõ†Ô∏è System Management (Version 4.0)

### üîß Basic Commands (Enhanced)
```bash
# View status of all containers
cd /home/n8n && docker-compose ps

# View realtime logs of all services
cd /home/n8n && docker-compose logs -f

# Restart entire system
cd /home/n8n && docker-compose restart

# Web Dashboard
http://YOUR_SERVER_IP:8080

# Auto-Fix System
/home/n8n/auto-fix.sh

# Health Monitor
systemctl status n8n-health-monitor

# Troubleshoot script
/home/n8n/troubleshoot.sh
```

### üìä Management Tools (Enhanced)
```bash
# Enhanced backup
/home/n8n/backup-workflows-enhanced.sh

# Restore system
/home/n8n/restore-from-backup.sh

# Manual backup test
/home/n8n/backup-manual.sh

# Auto-Fix System
/home/n8n/auto-fix.sh

# Health Monitor
/home/n8n/health_checks/health_monitor.sh
```

## üìÇ Enhanced Directory Structure (Version 4.0)

```
/home/n8n/
‚îú‚îÄ‚îÄ docker-compose.yml              # Main config with multi-domain
‚îú‚îÄ‚îÄ Dockerfile                      # N8N custom image
‚îú‚îÄ‚îÄ Caddyfile                       # Reverse proxy for all domains
‚îú‚îÄ‚îÄ init-multi-db.sh                # PostgreSQL init script
‚îú‚îÄ‚îÄ backup-workflows-enhanced.sh    # Enhanced backup script
‚îú‚îÄ‚îÄ restore-from-backup.sh          # Enhanced restore script
‚îú‚îÄ‚îÄ troubleshoot.sh                 # Multi-domain diagnostic script
‚îú‚îÄ‚îÄ auto-fix.sh                     # Auto-Fix system script
‚îú‚îÄ‚îÄ telegram_config.txt             # Telegram settings
‚îú‚îÄ‚îÄ dashboard/                      # Web Dashboard
‚îÇ   ‚îú‚îÄ‚îÄ index.html                 # Dashboard UI
‚îÇ   ‚îú‚îÄ‚îÄ api_server.py              # Dashboard API server
‚îÇ   ‚îî‚îÄ‚îÄ assets/                    # Static assets
‚îú‚îÄ‚îÄ telegram_bot/                   # Telegram Bot Management
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                     # Main bot script
‚îÇ   ‚îî‚îÄ‚îÄ start_bot.sh               # Bot startup script
‚îú‚îÄ‚îÄ google_drive/                   # Google Drive Integration
‚îÇ   ‚îú‚îÄ‚îÄ gdrive_backup.py           # Google Drive backup script
‚îÇ   ‚îú‚îÄ‚îÄ credentials.json           # Service account credentials
‚îÇ   ‚îî‚îÄ‚îÄ cleanup_old_backups.py     # Cleanup script
‚îú‚îÄ‚îÄ cloudflare/                     # Cloudflare Tunnel
‚îÇ   ‚îú‚îÄ‚îÄ config.yml                 # Tunnel configuration
‚îÇ   ‚îú‚îÄ‚îÄ credentials.json           # Cloudflare credentials
‚îÇ   ‚îî‚îÄ‚îÄ tunnel.log                 # Tunnel logs
‚îú‚îÄ‚îÄ health_checks/                  # Health Monitoring
‚îÇ   ‚îú‚îÄ‚îÄ health_monitor.sh          # Health monitor script
‚îÇ   ‚îú‚îÄ‚îÄ health_check.sh            # Health check script
‚îÇ   ‚îî‚îÄ‚îÄ auto_recovery.sh           # Auto recovery script
‚îú‚îÄ‚îÄ security/                       # Security configurations
‚îÇ   ‚îú‚îÄ‚îÄ setup_security.sh          # Security setup script
‚îÇ   ‚îú‚îÄ‚îÄ auth_credentials.txt        # Basic auth credentials
‚îÇ   ‚îú‚îÄ‚îÄ allowed_ips.txt            # IP whitelist
‚îÇ   ‚îî‚îÄ‚îÄ ssl_headers.conf           # SSL security headers
‚îú‚îÄ‚îÄ management/                     # Management tools
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.sh               # CLI dashboard
‚îÇ   ‚îú‚îÄ‚îÄ menu.sh                    # Management menu
‚îÇ   ‚îî‚îÄ‚îÄ export-migration.sh        # Migration tools
‚îú‚îÄ‚îÄ files/                          # N8N data
‚îÇ   ‚îú‚îÄ‚îÄ backup_full/               # Enhanced backup storage
‚îÇ   ‚îú‚îÄ‚îÄ n8n_instance_1/           # Instance 1 data
‚îÇ   ‚îú‚îÄ‚îÄ n8n_instance_2/           # Instance 2 data
‚îÇ   ‚îî‚îÄ‚îÄ n8n_instance_n/           # Instance N data
‚îú‚îÄ‚îÄ postgres_data/                  # PostgreSQL data (if enabled)
‚îú‚îÄ‚îÄ logs/                          # System logs
‚îî‚îÄ‚îÄ news_api/                       # News API (shared)
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îî‚îÄ‚îÄ main.py
```

## ‚ö° Performance Tips (Version 4.0)

### üöÄ Multi-Mode Optimization
1. **Localhost Mode**: Optimized for development and testing
2. **Domain Mode**: Optimized for production with SSL
3. **Cloudflare Mode**: Optimized for high security and no public IP
4. **Memory**: Script automatically increases swap for multi-domain
5. **CPU**: Each N8N instance uses optimized workers
6. **Database**: PostgreSQL shared connection pooling
7. **Disk**: Auto cleanup of old backups and logs
8. **Network**: Caddy auto-compression for all domains

### üìä Monitoring Multi-Mode (Enhanced)
```bash
# Resource usage of all containers
docker stats --no-stream

# Real-time dashboard
http://YOUR_SERVER_IP:8080

# Telegram monitoring
/status in Telegram Bot

# Performance metrics
/performance in Telegram Bot

# Health monitor
systemctl status n8n-health-monitor

# Auto-fix status
/home/n8n/auto-fix.sh status
```

## üêõ Troubleshooting (Version 4.0)

### ‚ùå Common Issues Enhanced

**1. Auto-Fix System not working**
```bash
# Check auto-fix service
systemctl status n8n-auto-fix

# Run auto-fix manually
/home/n8n/auto-fix.sh

# View auto-fix logs
tail -f /var/log/n8n-auto-fix.log
```

**2. Cloudflare Tunnel not connecting**
```bash
# Check tunnel status
systemctl status cloudflared

# View tunnel logs
journalctl -u cloudflared -f

# Test tunnel connection
cloudflared tunnel info
```

**3. Health Monitor not working**
```bash
# Check health monitor
systemctl status n8n-health-monitor

# View health monitor logs
journalctl -u n8n-health-monitor -f

# Restart health monitor
systemctl restart n8n-health-monitor
```

**4. Custom Ports not working**
```bash
# Check port usage
netstat -tulpn | grep :5678

# Check port conflicts
/home/n8n/auto-fix.sh ports

# Fix port issues
/home/n8n/auto-fix.sh networks
```

**5. Multi-Mode issues**
```bash
# Check installation mode
cat /home/n8n/installation_mode.txt

# Switch mode
/home/n8n/switch-mode.sh localhost
/home/n8n/switch-mode.sh domain
/home/n8n/switch-mode.sh cloudflare
```

## üåü Features Roadmap (Version 4.0)

- [x] **Multi-Mode** support (Localhost/Domain/Cloudflare) ‚úÖ
- [x] **Auto-Fix Integration** system ‚úÖ
- [x] **Health Monitoring** & Auto-Recovery ‚úÖ
- [x] **Custom Port Configuration** ‚úÖ
- [x] **Cloudflare Tunnel** support ‚úÖ
- [x] **Multi-domain** support ‚úÖ
- [x] **PostgreSQL** external database ‚úÖ
- [x] **Telegram Bot** management ‚úÖ
- [x] **Google Drive** backup ‚úÖ
- [x] **Web Dashboard** ‚úÖ
- [x] **Enhanced Security** ‚úÖ
- [ ] **Load balancing** between instances
- [ ] **Kubernetes** deployment
- [ ] **Advanced monitoring** dashboard with metrics
- [ ] **Auto-scaling** based on load
- [ ] **Plugin** marketplace integration
- [ ] **Cross-instance** workflow sharing
- [ ] **Multi-cloud** deployment support

## ü§ù Contributing

1. Fork repository
2. Create feature branch
3. Commit changes
4. Push to branch
5. Create Pull Request

## üìÑ License

MIT License - See [LICENSE](LICENSE) file

## üí¨ Support

- **Issues**: [GitHub Issues](https://github.com/KalvinThien/install-n8n-ffmpeg/issues)
- **YouTube**: [Kalvin Thien Social](https://www.youtube.com/@kalvinthiensocial)
- **Facebook**: [Ban Thien Handsome](https://www.facebook.com/Ban.Thien.Handsome/)
- **Zalo**: 08.8888.4749

## ‚≠ê Star History

If this script is useful, please give a ‚≠ê star to support!

[![Star History Chart](https://api.star-history.com/svg?repos=KalvinThien/install-n8n-ffmpeg&type=Date)](https://star-history.com/#KalvinThien/install-n8n-ffmpeg&Date)

---

**üöÄ Made with ‚ù§Ô∏è by Nguy·ªÖn Ng·ªçc Thi·ªán - 01/07/2025**  
**üÜï Enhanced Version 4.0 - Multi-Mode + Auto-Fix + Cloudflare Tunnel + Health Monitoring + Custom Ports**

## üîß Troubleshooting & Fix Issues (Version 4.0)

### üö® When encountering HTTP 502 errors or N8N not working

If you encounter the following issues:
- ‚ùå HTTP ERROR 502 when accessing domains
- ‚ùå N8N containers continuously restarting
- ‚ùå Permission denied errors
- ‚ùå PostgreSQL connection issues
- ‚ùå SSL certificate problems
- ‚ùå Cloudflare Tunnel connection issues
- ‚ùå Health monitor not working

### üõ†Ô∏è Comprehensive Auto-Fix System (Version 4.0)

**Script `auto-fix.sh` will automatically fix all issues:**

```bash
# 1. Auto-Fix System is already integrated
# Run comprehensive auto-fix
sudo /home/n8n/auto-fix.sh

# 2. Fix specific parts
sudo /home/n8n/auto-fix.sh permissions    # Fix permissions
sudo /home/n8n/auto-fix.sh networks       # Fix Docker networks
sudo /home/n8n/auto-fix.sh database       # Fix PostgreSQL
sudo /home/n8n/auto-fix.sh ssl            # Fix SSL certificates
sudo /home/n8n/auto-fix.sh ports          # Fix port conflicts
sudo /home/n8n/auto-fix.sh health         # Fix health monitor
```

### üîç Auto-Fix System will fix the following issues:

1. **‚úÖ Fix Permission Issues (1000:1000)**
   - Fix N8N directory permissions
   - Fix user/group ownership
   - Create missing directories

2. **üåê Fix Docker Network & Service Names**
   - Recreate Docker networks
   - Fix container name resolution
   - Clean up old networks

3. **üêò Fix PostgreSQL Database Issues**
   - Recreate users and databases
   - Fix connection issues
   - Test database connectivity

4. **üîí Fix SSL Certificate Problems**
   - Update Caddyfile with correct container names
   - Add health checks
   - Fix reverse proxy configuration

5. **‚òÅÔ∏è Fix Cloudflare Tunnel Issues**
   - Recreate tunnel configuration
   - Fix tunnel credentials
   - Restart tunnel service

6. **üîå Fix Custom Port Issues**
   - Resolve port conflicts
   - Reassign available ports
   - Update configuration files

7. **üè• Fix Health Monitor Issues**
   - Restart health monitor service
   - Fix health check scripts
   - Update monitoring configuration

8. **üöÄ Restart Services in Correct Order**
   - PostgreSQL ‚Üí N8N ‚Üí API ‚Üí Caddy ‚Üí Cloudflare
   - Verify service health
   - Clean up old containers

9. **üìä Health Check All Components**
   - Test container connectivity
   - Verify domain accessibility
   - Check SSL certificates
   - Test Cloudflare tunnel

### üìã Log and Monitoring (Enhanced)

Auto-Fix System will create detailed log file at `/var/log/n8n-auto-fix.log`

```bash
# View auto-fix logs
tail -f /var/log/n8n-auto-fix.log

# Monitor containers after fix
cd /home/n8n && docker-compose logs -f

# Check status
cd /home/n8n && docker-compose ps

# Health monitor status
systemctl status n8n-health-monitor
```

### üéØ Expected results after auto-fix:

‚úÖ All domains working normally  
‚úÖ SSL certificates issued automatically  
‚úÖ N8N instances starting stably  
‚úÖ PostgreSQL connection successful  
‚úÖ Cloudflare Tunnel working  
‚úÖ Health Monitor active  
‚úÖ No more HTTP 502 errors  
‚úÖ Auto-Fix System ready  

**‚è∞ Note**: Wait 2-3 minutes after fixing for SSL certificates to be fully issued and Cloudflare Tunnel to connect.

### üîÑ Auto-Fix Integration with Telegram Bot

```bash
# Telegram Bot commands for auto-fix
/auto-fix                 # Run comprehensive auto-fix
/auto-fix permissions     # Fix permissions
/auto-fix networks        # Fix Docker networks
/auto-fix database        # Fix PostgreSQL
/auto-fix ssl             # Fix SSL certificates
/auto-fix health          # Fix health monitor
/auto-fix status          # View auto-fix status
``` 